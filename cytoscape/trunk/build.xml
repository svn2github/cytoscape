<?xml version="1.0"?>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- Build file for Cytoscape 			        -->
<!-- Created by Ethan Cerami, cerami@cbio.mskcc.org	-->
<!-- To get a quick listing of all ant targets, type: 	-->
<!-- ant -projecthelp                                   -->
<!-- ======================================================= -->
<!-- ======================================================= -->


<project name="Cytoscape" default="compile" basedir=".">

    <!-- ======================================================= -->
    <!-- Define Directories and other environment variables      -->
    <!-- ======================================================= -->

    <!-- The directory containing library jar files -->
    <property name="lib.dir" value="${basedir}/lib"/>

    <!-- The directory containing source code -->
    <property name="src.dir" value="${basedir}/src"/>

    <!-- The directory containing resources -->
    <property name="resources.dir" value="${basedir}/resources"/>

    <!-- Temporary build directory -->
    <!-- Any file generated by a build target should go in the build dir. -->
    <property name="build.dir" value="${basedir}/build"/>

    <!-- JUnit report directory -->
    <property name="junit.report.dir" value="${build.dir}/junit-reports"/>

    <!-- Temporary compiled classes directory -->
    <property name="build.classes" value="${build.dir}/classes"/>

    <!-- Global "magic" property for <javac> -->
    <property name="build.compiler" value="modern"/>

    <!-- Release number -->
    <property name="version" value="2.3"/>

    <property name="dirname.release.dir"
              value="cytoscape-v${version}"/>

    <!-- Web Start Directory -->
    <property name="webstart.dir" value="${build.dir}/webstart"/>

    <!-- Temporary Release Directory -->
    <property name="release.dir" value="${build.dir}/${dirname.release.dir}"/>

    <!-- Temporary Zip/Gzipped Release Directory -->
    <property name="zip_release.dir" value="${build.dir}/zip_release"/>

    <!-- Mac OS X Application Directory -->
    <property name="mac_app.dir" value="${release.dir}/Cytoscape.app"/>

    <!-- Javadoc directories -->
    <property name="javadoc.private.dir" value="${build.dir}/API-private"/>
    <property name="javadoc.public.dir" value ="${build.dir}/API-public"/>

    <!--
         ==========================================================
        The following section was created by Keiichiro Ono,
        kono@ucsd.edu for JAXB Databinding
        ===========================================================
    --> 
    
    <!-- The XML Schema Directory used by JAXB -->
    <property name="schema.dir" value="${basedir}/schema" />
    
    <!-- XML Schema files used by JAXB -->
    <property name="xgmml.schema" value="xgmml.xsd" />
    <property name="cysession.schema" value="cysession.xsd" />
    
    <!-- Auto generated package name -->
    <property name="package" value="cytoscape.generated" />
    


    <!-- ======================================================= -->
    <!-- Cytoscape ClassPath definition                          -->
    <!-- ======================================================= -->

    <!-- Classpath with all lib JAR Files -->
    <path id="classpath">
        <pathelement path="${build.classes}"/>
        <!-- <pathelement path="${basedir}"/> -->
        <fileset dir="${lib.dir}">
            <include name="**/*.jar"/>
        </fileset>
    </path>
    
    <!-- ======================================================= -->
    <!-- For XJC compiler task -->
    <!-- ======================================================= -->
    <taskdef name="xjc" classname="com.sun.tools.xjc.XJCTask">
        <classpath refid="classpath" />
    </taskdef>
    
    <!-- ======================================================= -->
    <!-- Clean generated packages -->
    <!-- ======================================================= -->
    <target name="clean-generated" description="Delete XJC generated packages.">
        
        <!-- Clean up generated packages -->
        <delete dir="${src.dir}/cytoscape/generated"/>
        <delete dir="${src.dir}/cytoscape/generated2"/>
    </target>
    
    <!-- ======================================================= -->
    <!-- Generate package using XJC compiler            -->
    <!-- ======================================================= -->
    <target name="bind" description="Run XJC to generate new packages.">
        
        <xjc schema="${schema.dir}/${cysession.schema}" target="${src.dir}" package="${package}">
            <produces dir="${src.dir}/cytoscape/generated" includes="* impl/*" />
        </xjc>
        <xjc schema="${schema.dir}/${xgmml.schema}" target="${src.dir}" 
            package="${package}2" extension="true"
            binding="${schema.dir}/binding.xjb">
            <arg value="-nv" />
            <produces dir="${src.dir}/cytoscape/generated2" includes="* impl/*" />
        </xjc>
        <!-- copy prop file into build dir -->
        <echo>Copying jaxb.properties from ${src.dir}/cytoscape/generated to build dir...</echo>
        <copy todir="${build.classes}/cytoscape/generated">
            <fileset dir="${src.dir}/cytoscape/generated" includes="*.properties"/>
        </copy>
        <copy todir="${build.classes}/cytoscape/generated2">
            <fileset dir="${src.dir}/cytoscape/generated2" includes="*.properties"/>
        </copy>
        
    </target>
    
    

    <!-- ======================================================= -->
    <!-- Environment Information                                 -->
    <!-- ======================================================= -->

    <!-- Outputs Current compilation classpath -->
    <target name="show_cp">
        <property name="temp" refid="classpath"/>
        <echo message="Classpath:  ${temp}"/>
    </target>

    <!-- ======================================================= -->
    <!-- Create Build directories and copy images                -->
    <!-- ======================================================= -->

    <!-- Target to create the build directories prior to compilation -->
    <target name="prepare">
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${build.classes}"/>

        <!-- copy over images -->
        <copy todir="${build.classes}/cytoscape/images">
            <fileset dir="${basedir}/images"/>
        </copy>
        <copy todir="${build.classes}/cytoscape/view/images">
            <fileset dir="${basedir}/images"/>
        </copy>
        <copy todir="${build.classes}/cytoscape/dialogs/images">
            <fileset dir="${src.dir}/cytoscape/dialogs/images"/>
        </copy>
        <copy todir="${build.classes}/cytoscape/visual/ui/images">
            <fileset dir="${src.dir}/cytoscape/visual/ui/images"/>
        </copy>


        <copy todir="${build.classes}">
		<fileset dir="${src.dir}" includes="**/*.xml" />
        </copy>


        <available property="manifest_generated"
                   file="${build.dir}/cytoscape.manifest"/>
    </target>

    <!-- ======================================================= -->
    <!-- Clean the build environment                             -->
    <!-- ======================================================= -->

    <!--  Target to clean out all directories -->
    <target name="clean" depends="clean-generated" description="Removes all generated files.">
        <delete dir="${build.dir}"/>
        <delete file="${basedir}/cytoscape.jar"/>
        <delete file="${basedir}/cytoscape.props"/>
    	    <!-- iliana commented this out, this is very wrong!!! -->
        <!-- <delete file="${basedir}/vizmap.props"/> -->
    </target>

    <!-- ======================================================= -->
    <!-- Compile Cytoscape                                       -->
    <!-- ======================================================= -->
    <!--  Target to compile all code -->
    <target name="compile" depends="prepare, bind"
            description="Compiles all source code.">
        <javac srcdir="${src.dir}"
               destdir="${build.classes}"
               nowarn="off"
               debug="true"
               source="1.4"
               optimize="on"
               includeAntRuntime="false" 
	       deprecation="yes"
	       >
            <classpath refid="classpath"/>
            <include name="cytoscape/**"/>
        </javac>

        <!-- Run RMIC for BioDataServer -->
        <rmic classname="cytoscape.data.servers.BioDataServerRmi"
              base="${build.classes}" classpathref="classpath"/>

	<!-- copy resources/ directory to build area -->
	<echo>Copying resources/ directory to build</echo>
	<copy todir="${build.classes}/cytoscape/resources">
	  <fileset dir="${basedir}/resources"/>
		<fileset file="${basedir}/props/tax_report.txt"/>
	</copy>


	<!-- build help system -->
	<antcall target="help" />

    </target>


    <!-- ======================================================= -->
    <!-- Build Cytoscape Help - Index html source files etc.     -->
    <!-- ======================================================= -->
    <target name="help"
	    description="Builds Help system files (full text search db, etc).">
	<!-- Check to see if the help files need to be indexed... -->
	<uptodate property="helpIsUpToDate"
		targetfile="${build.classes}/cytoscape/help/CytoscapeSearch/SCHEMA">
	  <srcfiles dir= "${basedir}/help/html" includes="**/*.html"/>
	</uptodate>
	<antcall target="buildHelp"/>
    </target>

    <target name="buildHelp"  unless="helpIsUpToDate">
	<!-- Copy the JavaHelp system files and html source over to build area -->
	<echo>Copying javahelp files: helpset, html files, images</echo>
        <copy todir="${build.classes}/cytoscape/help">
            <fileset dir="${basedir}/help"/>
        </copy>

	<!-- then index the help files in the build area -->
	<echo>Indexing help files and creating search db</echo>
        <java classname="com.sun.java.help.search.Indexer"
	      classpathref="classpath"
	      dir="${build.classes}/cytoscape/help"
	      fork="true">
            <arg value="-db"/>
            <arg value="CytoscapeSearch"/>
            <arg value="html"/>
        </java>
    </target>


    <!-- ======================================================= -->
    <!-- Run Cytoscape                                           -->
    <!-- ======================================================= -->

    <!--  Target to Run Cytoscape -->
    <target name="run" depends="jar" description="Runs Cytoscape.">
        <java jar="${basedir}/cytoscape.jar"
              fork="true">
        		<arg value="-p"/>
        		<arg value="plugins/core"/>
        </java>
    </target>

    <!-- ======================================================= -->
    <!-- Make the JavaDocs for Cytoscape                         -->
    <!-- ======================================================= -->

    <!-- Target to Run JavaDoc -->
    <target name="doc-private" description="Runs JavaDoc.">
        <javadoc destdir="${javadoc.private.dir}"
                 source="1.4"
                 classpathref="classpath"
                 link="http://java.sun.com/j2se/1.4.2/docs/api/">

            <packageset dir="${src.dir}">
                <include name="cytoscape/**"/>
                <exclude name="cytoscape/data/servers/archive/"/>
                <exclude name="cytoscape/data/servers/unitTests/"/>
                <exclude name="cytoscape/unitTests/deferred/"/>
                <exclude name="**test/**"/>
                <exclude name="**/unitTests/**"/>
            </packageset>
        </javadoc>
    </target>

    <!-- ======================================================= -->
    <!-- Make the Public JavaDocs for Cytoscape                         -->
    <!-- ======================================================= -->

    <!-- Target to Run JavaDoc -->
    <target name="doc" description="Runs JavaDoc.">
        <javadoc destdir="${javadoc.public.dir}"
                 source="1.4"
                 Windowtitle="Cytoscape 2.2 API"
                 header="Cytoscape 2.2 (c) 2004 ISB, MSKCC, UCSD"
                 footer="www.cytoscape.org"
                 classpathref="classpath"
		 access="public">

            <fileset dir="${src.dir}">
                <include name="cytoscape/*.java" />
                <include name="cytoscape/util/*.java" />
                <include name="cytoscape/util/swing/*.java" />
                <include name="cytoscape/plugin/*.java" />
                <include name="cytoscape/plugin/jar/JarLoader.java" />
                <include name="cytoscape/plugin/jar/SimpleClassLoader.java" />
                <include name="cytoscape/data/ExpressionData.java" />
                <include name="cytoscape/data/Semantics.java" />
                <include name="cytoscape/data/CyAttributes.java" />
                <include name="cytoscape/view/CytoscapeDesktop.java" />
                <include name="cytoscape/view/CyNetworkView.java" />
                <include name="cytoscape/view/CyMenus.java" />
                <include name="cytoscape/view/cytopanels/*.java" />
                <include name="cytoscape/visual/VisualStyle.java" />
                <include name="cytoscape/visual/VisualMappingManager.java" />
                <include name="cytoscape/layout/*.java" />
                <include name="cytoscape/data/servers/BioDataServer*.java" />
            </fileset>
	    <packageset dir="${src.dir}" defaultexcludes="yes">
		    <include name="cytoscape/task/**" />
    	    </packageset>
            <packageset dir="${src.dir}" defaultexcludes="yes">
                <include name="cytoscape/data/attr/**"/>
                <exclude name="cytoscape/data/attr/util/test/**"/>
            </packageset>

         <link href="http://java.sun.com/j2se/1.4.2/docs/api/" />
         <link href="http://csbi.sourceforge.net/API/" />
         <doctitle>Cytoscape 2.2 API</doctitle>
         </javadoc>
    </target>

    <!-- ======================================================= -->
    <!-- Create the Cytoscape Jar file                           -->
    <!-- ======================================================= -->

    <!--  Target to Create Cytoscape Jar File  -->
    <target name="jar" depends="compile, generate_manifest"
            description="Creates Cytoscape Jar File.">

        <echo>
            ***********************************************
            Creating Cytoscape JAR File
            ***********************************************
        </echo>

        <copy file="${basedir}/tools/jars/javax.imageio.spi.ImageWriterSpi"
              todir="${build.dir}/temp/META-INF/services"/>
        <copy
            file="${basedir}/tools/jars/org.freehep.util.export.ExportFileType"
            todir="${build.dir}/temp/META-INF/services"/>
        <copy file="${basedir}/props/vizmap.props" todir="${build.classes}"/>
        <copy file="${basedir}/props/cytoscape.props" todir="${build.classes}"/>
        <jar destfile="${basedir}/cytoscape.jar"
             manifest="${build.dir}/cytoscape.manifest">
            <fileset dir="${build.classes}"/>
            <fileset dir="${build.dir}/temp"/>
        </jar>
        <copy file="${basedir}/props/cytoscape.props" todir="${basedir}"/>
        <copy file="${basedir}/props/tax_report.txt" todir="${basedir}"/>
    </target>

    <!-- =================================================================== -->
    <!-- Runs the tests in the project jar quickly, and sets a property      -->
    <!-- if a test fails.                                                    -->
    <!-- =================================================================== -->
    <target name="test-fast" depends="jar">
      <echo>
            ***********************************************
            Running all unit tests (quickly). 
            ***********************************************
      </echo>
      <junit printsummary="yes"
             haltonfailure="no"
             maxmemory="512m">
	<!-- We need a new classpath so that AllTests is read from
	     the cytoscape.jar file instead of the build dir which
	     allows it reflect on the jar file and find other tests. -->
        <classpath> 
            <fileset dir="${basedir}">
                <include name="**/*.jar"/>
            </fileset>
            <fileset dir="${lib.dir}">
                <include name="**/*.jar"/>
            </fileset>
        </classpath>
        <test name="cytoscape.unitTests.AllTests"
              fork="yes"
              todir="${junit.report.dir}"
              failureProperty="junit.test.failure"
              errorProperty="junit.test.failure">
        </test>
      </junit>
    </target>


    <!-- ======================================================= -->
    <!-- Run All of the Cytoscape Unit Tests without gui         -->
    <!-- and generates an html report. This task is only run     -->
    <!-- if the test-fast case fails.                            -->
    <!-- ======================================================= -->
    <target name="test" 
            depends="test-fast"
            if="junit.test.failure">
      <echo>
            ***********************************************
            Running all unit tests individually. 
            ***********************************************
      </echo>
      <mkdir dir="${junit.report.dir}"/>
      <junit printsummary="yes"
             haltonfailure="no"
             maxmemory="512m">
        <classpath refid="classpath"/>
          <formatter type="plain"
                     usefile="true" />
          <formatter type="xml"
                     usefile="true" />
        <batchtest fork="yes"
                   todir="${junit.report.dir}" 
		   failureProperty="junit.test.failure">
          <fileset dir="${src.dir}"
                   includes="**/*Test.java"
                   excludes="**/AllTests.java" />
        </batchtest>
      </junit>

      <junitreport todir="${junit.report.dir}">
        <fileset dir="${junit.report.dir}">
          <include name="TEST-*.xml"/>
        </fileset>
        <report format="frames" todir="${junit.report.dir}"/>
      </junitreport>

      <fail message="JUnit Tests failed! Check ${junit.report.dir}/index.html for details."
            if="junit.test.failure" />

    </target>

    <!-- ======================================================= -->
    <!-- Run All of the Cytoscape Unit Tests                     -->
    <!-- ======================================================= -->
    <target name="test-gui" depends="jar"
            description="Runs all Cytoscape Unit Tests.">

        <!-- Create a new classpath so that we're running from a jar file 
	     which is needed by AllTests. -->
        <path id="junit.classpath">
          <fileset dir="${lib.dir}">
            <include name="**/*.jar"/>
          </fileset>
          <fileset dir="${basedir}">
            <include name="**/*.jar"/>
          </fileset>
        </path>

        <java classname="cytoscape.unitTests.AllTests"
              classpathref="junit.classpath" fork="true">
            <arg line="-ui"/>
        </java>
    </target>

    <!-- ======================================================= -->
    <!-- Run all of the Swing Unit Tests                         -->
    <!-- ======================================================= -->
    <target name="test-swing" depends="jar">
      <mkdir dir="${junit.report.dir}"/>
      <junit printsummary="yes"
             haltonfailure="no"
             maxmemory="512m">
        <classpath refid="classpath"/>
          <formatter type="plain"
                     usefile="true" />
          <formatter type="xml"
                     usefile="true" />
        <batchtest fork="yes"
                   todir="${junit.report.dir}" 
		   failureProperty="junit.test.failure">
          <fileset dir="${src.dir}"
                   includes="**/*TestSwing.java"/>
        </batchtest>
      </junit>

      <junitreport todir="${junit.report.dir}">
        <fileset dir="${junit.report.dir}">
          <include name="TEST-*.xml"/>
        </fileset>
        <report format="frames" todir="${junit.report.dir}"/>
      </junitreport>

      <fail message="JUnit Tests failed! Check ${junit.report.dir}/index.html for details."
            if="junit.test.failure" />

    </target>

    <!-- ======================================================= -->
    <!-- Create Cytoscape Distribution                           -->
    <!-- Use the 'zip_release' target to build zipped releases   -->
    <!-- Questions?  email:  cerami@cbio.mskcc.org	         -->
    <!-- ======================================================= -->
    <target name="release" depends="jar, test"
            description="Creates Cytoscape Release">

        <echo>
            ***********************************************
            Creating Cytoscape Release
            ***********************************************
        </echo>

        <!-- Create Release Directory -->
        <mkdir dir="${release.dir}"/>
        <mkdir dir="${release.dir}/plugins"/>
        <mkdir dir="${release.dir}/annotation"/>
        <mkdir dir="${release.dir}/sampleData"/>

        <echo>
            ---------------------------------------
            Copying over all necessary JAR files.
            ---------------------------------------
        </echo>

        <copy file="${basedir}/cytoscape.jar"
              tofile="${release.dir}/cytoscape.jar"/>

        <copy toDir="${release.dir}/lib">
          <fileset dir="${lib.dir}" includes="*.jar"/>
        </copy>

        <!-- Copy over start scripts -->
        <echo>
            ---------------------------------------
            Copying over all OS-specific scripts.
            ---------------------------------------
        </echo>
        <copy file="bin/cytoscape.bat" todir="${release.dir}"/>
        <copy file="bin/cytoscape.sh" todir="${release.dir}"/>
        <chmod perm="+x" file="${release.dir}/cytoscape.bat"/>
        <chmod perm="+x" file="${release.dir}/cytoscape.sh"/>

        <!-- Copy over props files -->
        <echo>
            ---------------------------------------
            Copying over all property files.
            ---------------------------------------
        </echo>
	<!--
        <copy file="${basedir}/props/cytoscape.props"
              tofile="${release.dir}/cytoscape.props"/>
        <copy file="${basedir}/props/vizmap.props"
              tofile="${release.dir}/vizmap.props"/>
	      -->
    		 <copy file="${basedir}/props/tax_report.txt"
    	         tofile="${release.dir}/tax_report.txt"/>
    	   <copy file="${basedir}/props/tax_report.txt"
    	    	         tofile="${release.dir}/annotation/tax_report.txt"/>
    	
        <!-- Copy over Txt/PDF files -->
        <echo>
            ---------------------------------------
            Copying over user documentation and Cytoscape License.
            ---------------------------------------
        </echo>

        <copy file="user_docs/INSTALL.txt" todir="${release.dir}"/>
        <copy file="user_docs/LICENSE.txt" todir="${release.dir}"/>
        <copy file="user_docs/Cytoscape2_2Manual.pdf" todir="${release.dir}"/>
        <!--<copy file="user_docs/Cyto-2.2-Features.pdf" todir="${release.dir}"/>-->

        <!-- Copy over Sample Data Files -->
        <echo>
            ---------------------------------------
            Copying over sample data files.
            ---------------------------------------
        </echo>

        <copy file="testData/sampleDataContents.txt"
              todir="${release.dir}/sampleData"/>
        <copy file="testData/BINDyeast.sif" todir="${release.dir}/sampleData"/>
        <copy file="testData/BINDhuman.sif" todir="${release.dir}/sampleData"/>
        <copy file="testData/galExpData.pvals"
              todir="${release.dir}/sampleData"/>
        <copy file="testData/galFiltered.gml"
              todir="${release.dir}/sampleData"/>
        <copy file="testData/galFiltered.sif"
              todir="${release.dir}/sampleData"/>
        <copy file="testData/yeastHighQuality.sif"
              todir="${release.dir}/sampleData"/>
        <copy file="testData/galFiltered.edgeAttrs1" 
	      todir="${release.dir}/sampleData"/>
        <copy file="testData/galFiltered.edgeAttrs2" 
              todir="${release.dir}/sampleData"/>
        <copy file="testData/galFiltered.nodeAttrs1" 
	      todir="${release.dir}/sampleData"/>
        <copy file="testData/galFiltered.nodeAttrs2" 
	      todir="${release.dir}/sampleData"/>
        <copy file="testData/galExpData.pvals" 
	      todir="${release.dir}/sampleData"/>

        <!-- Copy over annotation Data Files -->
        <copy todir="${release.dir}/annotation">
            <fileset dir="testData/annotation">
                <include name="manifest"/>
                <include name="go.onto"/>
                <include name="kegg.onto"/>
                <include name="bioproc.anno"/>
                <include name="molfunc.anno"/>
                <include name="cellcomp.anno"/>
                <include name="kegg.anno"/>
                <include name="yeast.syno"/>
                <include name="manifest2"/>
                <include name="gene_ontology.obo"/>
                <include name="gene_association.sgd"/>
            	    <include name="gene_association.goa_human"/>
            </fileset>
        </copy>

        <!-- Copy over Third Party Licenses -->
        <echo>
            ---------------------------------------
            Copying over third party licenses.
            ---------------------------------------
        </echo>
        <mkdir dir="${release.dir}/licenses"/>
        <copy todir="${release.dir}/licenses">
            <fileset dir="licenses">
                <include name="*.txt"/>
                <include name="*.htm*"/>
            </fileset>
        </copy>

        <!-- Copy over Release PlugIns -->
        <echo>
            ---------------------------------------
            Copying over PlugIns.
            ---------------------------------------
        </echo>
        <copy todir="${release.dir}/plugins">
            <fileset dir="plugins/core">
                <include name="*.jar"/>
            </fileset>
        </copy>
        <copy file="plugins/core/pluginsContents.txt"
              todir="${release.dir}/plugins"/>
    </target>

    <target name="all" depends="release"/>

    <target name="release-extras" depends="release"
            description="add extra plugins into release">
        <echo>
            ---------------------------------------
            Copying over extra PlugIns.
            ---------------------------------------
        </echo>
        <copy todir="${release.dir}/plugins">
            <fileset dir="plugins/extras">
                <include name="*.jar"/>
            </fileset>
        </copy>
    </target>


    <!-- ======================================================= -->
    <!-- Creates a distribution based on the nightly build.      -->
    <!-- ======================================================= -->
    <target name="nightly-release" depends="release">
    	<tstamp>
	      <format property="todays.date" pattern="yyyy-MM-dd_hh:mmaa"/>
        </tstamp>
        <mkdir dir="${zip_release.dir}"/>
        <zip destfile="${zip_release.dir}/cytoscape-${todays.date}.zip"
             basedir="${build.dir}"
             includes="${dirname.release.dir}/**"/>
    </target>

    <!-- ======================================================= -->
    <!-- Create Cytoscape Distribution                           -->
    <!-- Final releases are made available in zip_release/ dir   -->
    <!-- Questions?  email:  cerami@cbio.mskcc.org	         -->
    <!-- ======================================================= -->
    <target name="zip_release" depends="release"
            description="Creates Zipped Cytoscape Release Bundles">

        <echo>
            ---------------------------------------
            Creating zip/tar.gz release bundles.
            ---------------------------------------
        </echo>
        <mkdir dir="${zip_release.dir}"/>

        <!-- Create Windows Zip Distribution -->
        <zip destfile="${zip_release.dir}/cytoscape-v${version}.zip"
             basedir="${build.dir}"
             includes="${dirname.release.dir}/**"/>
             <!-- Stupid Ant does not preserve execute permissions. -->

        <!-- Create Unix/Linux/MaxOS X tar.gz Distribution -->
        <!-- Include Executable Permissions -->
        <tar tarfile="${zip_release.dir}/cytoscape-v${version}.tar">
            <tarfileset dir="${build.dir}" mode="755"> <!-- Stupid Ant. -->
                <include name="${dirname.release.dir}/*.sh"/>
                <include name="${dirname.release.dir}/*.bat"/>
            </tarfileset> <!-- Stupid Ant makes this so hard when it's not. -->
            <tarfileset dir="${build.dir}"> <!-- It's Java's fault. -->
                <include name="${dirname.release.dir}/**"/>
                <exclude name="${dirname.release.dir}/*.sh"/>
                <exclude name="${dirname.release.dir}/*.bat"/>
            </tarfileset>
        </tar>
        <gzip src="${zip_release.dir}/cytoscape-v${version}.tar"
              zipfile="${zip_release.dir}/cytoscape-v${version}.tar.gz"/>
        <delete file="${zip_release.dir}/cytoscape-v${version}.tar"/>

   </target>

     <!--  Create tar.gz release of source code -->
     <!--  Note that the source tar because does not preserve -->
     <!--  individual permissions of files.  This is a bug in Ant/Java.  -->
     <target name="source" description="Generates a release .tar.gz of all source code">
        <tar tarfile="${zip_release.dir}/cytoscapeSource-v${version}.tar">
		<tarfileset dir="${basedir}">
		<exclude name="build/**"/>
                <exclude name="CVS/**"/>
                <exclude name="*.log"/>
            </tarfileset>
        </tar>
        <gzip src="${zip_release.dir}/cytoscapeSource-v${version}.tar"
              zipfile="${zip_release.dir}/cytoscapeSource-v${version}.tar.gz"/>
        <delete file="${zip_release.dir}/cytoscapeSource-v${version}.tar"/>
    </target>



    <!-- ======================================================= -->
    <!-- Create Mac OS X Application Bundle                      -->
    <!-- Questions?  email:  cerami@cbio.mskcc.org               -->
    <!-- ======================================================= -->
    <target name="mac" depends="release"
            description="Creates a Mac-specific application in an Application Bundle directory.">
        <delete dir="${mac_app.dir}"/>
        <mkdir dir="${mac_app.dir}"/>
        <copy todir="${mac_app.dir}">
            <fileset dir="tools/mac_template"/>
        </copy>

        <!-- Create a symbolic link to the plugin directory -->
        <exec executable="ln" dir="${mac_app.dir}">
            <arg line="-s ../plugins plugins"/>
        </exec>

        <!-- Create a symbolic link to the Cytoscape JAR in the parent dir -->
        <!-- This way there is only one cytoscape.jar to update  -->
        <mkdir dir="${mac_app.dir}/Contents/Resources/Java" />
        <exec executable="ln" dir="${mac_app.dir}/Contents/Resources/Java">
            <arg line="-s ../../../../cytoscape.jar cytoscape.jar"/>
        </exec>

        <move file="${mac_app.dir}/mac.jar" todir="${release.dir}/plugins"/>

        <!-- Set Files to executable -->
        <chmod file="${mac_app.dir}/Contents/MacOS/JavaApplicationStub"
               perm="+x"/>
        <chmod file="${mac_app.dir}/Contents/Info.plist" perm="+x"/>
        <chmod file="${mac_app.dir}/Contents/PkgInfo" perm="+x"/>

	<echo message="Mac OS X App is now ready. See ${mac_app.dir}."/>
	<echo message="To complete the Mac release, refer to README.txt"/>
    </target>

    <!-- ======================================================= -->
    <!-- Manfiest Target                                         -->
    <!-- Automatically creates Cytoscape Manifest File, based on -->
    <!-- JAR Files located in cytoscape.lib                      -->
    <!-- ======================================================= -->
    <target name="generate_manifest" depends="prepare"
            unless="manifest_generated">
        <echo>
            ***********************************************
            Creating Cytoscape Manifest File
            ***********************************************
        </echo>
        <mkdir dir="${build.dir}/.build"/>
        <javac destdir="${build.dir}/.build"
               srcdir="${basedir}/.build"
               includeAntRuntime="no"/>
        <delete file="${build.dir}/cytoscape.manifest"/>
        <java fork="true"
              classname="ManifestCreator"
              output="${build.dir}/cytoscape.manifest">
            <classpath path="${build.dir}/.build"/>
            <arg value="${lib.dir}"/>
        </java>
    </target>

    
    <!-- ======================================================= -->
    <!-- Create Cytoscape WebStart Distribution                           -->
    <!-- Questions?  email:  cerami@cbio.mskcc.org	         -->
    <!-- ======================================================= -->
    <target name="webstart" depends="jar"
            description="Creates Cytoscape Webstart Release">

        <echo>
            ***********************************************
            Creating Cytoscape Webstart Release
            * NOTE: If this is your first time using Webstart:
            * you must create a keystore:
            * keytool -genkey -alias cytoscape -keypass secret
            * enter "secret" for the password. 
            ***********************************************
        </echo>

        <!-- Create Webstart Directory -->
        <mkdir dir="${webstart.dir}"/>
        <mkdir dir="${webstart.dir}/plugins"/>
        
        <echo>
             ------------------------------------
             All Files in the data directory are
             being included in data.jar
             ------------------------------------
        </echo>

        <jar destfile="${webstart.dir}/data.jar"
             basedir="data"
             includes="**"/>
        <signjar jar="${webstart.dir}/data.jar"
                 alias="cytoscape"
                 storepass="secret"/>

        <echo>
            ---------------------------------------
            Copying over all necessary JAR files.
            ---------------------------------------
        </echo>
        
        <copy file="${basedir}/cy1.jnlp"
              tofile="${webstart.dir}/cy1.jnlp"/>


        <copy file="${basedir}/cytoscape.jar"
              tofile="${webstart.dir}/cytoscape.jar"/>
        <signjar jar="${webstart.dir}/cytoscape.jar"
                 alias="cytoscape"
                 storepass="secret"/>

        <copy toDir="${webstart.dir}/lib">
          <fileset dir="${lib.dir}" includes="*.jar"/>
        </copy>

         <signjar alias="cytoscape"
                  storepass="secret">
                  <fileset  dir="${webstart.dir}/lib"
                  includes="*.jar"/>
        </signjar>
        
      

        <!-- Copy over props files -->
        <echo>
            ---------------------------------------
            Copying over all property files.
            ---------------------------------------
        </echo>
        <copy file="${basedir}/cytoscape.props"
              tofile="${webstart.dir}/cytoscape.props"/>
        <copy file="${basedir}/vizmap.props"
              tofile="${webstart.dir}/vizmap.props"/>
    	   <copy file="${basedir}/tax_report.txt"
    	              tofile="${webstart.dir}/tax_report.txt"/>

        <!-- Copy over Webstart PlugIns -->
        <echo>
            ---------------------------------------
            Copying over PlugIns.
            ---------------------------------------
        </echo>
        <copy todir="${webstart.dir}/plugins">
            <fileset dir="plugins/core">
                <include name="*.jar"/>
            </fileset>
        </copy>
        <copy todir="${webstart.dir}/plugins">
            <fileset dir="plugins">
                <include name="*.jar"/>
            </fileset>
        </copy>

        <copy file="plugins/core/pluginsContents.txt"
              todir="${webstart.dir}/plugins"/>

         <signjar alias="cytoscape"
                  storepass="secret">
                   <fileset dir="${webstart.dir}/plugins"  includes="*.jar"/>
         </signjar>

         



    </target>

    <target name="webstart-extras" depends="webstart"
            description="add extra plugins into webstart">
        <echo>
            ---------------------------------------
            Copying over extra PlugIns.
            ---------------------------------------
        </echo>
        <copy todir="${webstart.dir}/plugins">
            <fileset dir="plugins/extras">
                <include name="*.jar"/>
            </fileset>
        </copy>
    </target>


</project>
